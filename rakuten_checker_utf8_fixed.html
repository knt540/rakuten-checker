
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æ¥½å¤©ãƒ–ãƒƒã‚¯ã‚¹é€šçŸ¥ãƒã‚§ãƒƒã‚«ãƒ¼</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    button { margin: 10px 0; padding: 10px 20px; font-size: 16px; }
    #log { margin-top: 20px; }
    .log-entry { margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
  </style>
</head>
<body>
  <h1>æ¥½å¤©ãƒ–ãƒƒã‚¯ã‚¹é€šçŸ¥ãƒã‚§ãƒƒã‚«ãƒ¼</h1>
  <button id="permissionBtn">ğŸ”” é€šçŸ¥ã‚’è¨±å¯ã™ã‚‹</button>
  <button id="testBtn">ğŸ§ª é€šçŸ¥ãƒ†ã‚¹ãƒˆ</button>
  <p>æ¯åˆ†ã€Œ00ç§’ã€ã€Œ30ç§’ã€ã«å•†å“çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚</p>
  <div id="log"></div>

  <script>
    const url = "https://books.rakuten.co.jp/rb/18210487/";
    let lastStatus = "unavailable";

    function getJapanTimeString() {
      const now = new Date();
      const japanOffset = 9 * 60;
      const localOffset = now.getTimezoneOffset();
      const japanTime = new Date(now.getTime() + (japanOffset + localOffset) * 60000);
      return japanTime.toLocaleString("ja-JP", { hour12: false });
    }

    function logStatus(message) {
      const logDiv = document.getElementById("log");
      const entry = document.createElement("div");
      entry.className = "log-entry";
      entry.textContent = `[${getJapanTimeString()}] ${message}`;
      logDiv.insertBefore(entry, logDiv.firstChild);
    }

    document.getElementById("permissionBtn").addEventListener("click", () => {
      Notification.requestPermission().then(permission => {
        alert(permission === "granted" ? "é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸï¼" : "é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚");
      });
    });

    document.getElementById("testBtn").addEventListener("click", () => {
      try {
        if (Notification.permission === "granted") {
          const notification = new Notification("ãƒ†ã‚¹ãƒˆé€šçŸ¥", {
            body: "ã“ã‚Œã¯é€šçŸ¥æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆã§ã™ã€‚",
            icon: "https://books.rakuten.co.jp/favicon.ico",
            data: { url: url }
          });
          notification.onclick = e => {
            e.preventDefault();
            window.open(notification.data.url, "_blank");
          };
        } else {
          alert("é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å…ˆã«é€šçŸ¥ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚");
        }
      } catch (err) {
        alert("é€šçŸ¥ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
      }
    });

    async function checkStatus() {
      try {
        const response = await fetch(url);
        const text = await response.text();
        const isUnavailable = text.includes("ã”æ³¨æ–‡ã§ããªã„å•†å“");
        const isAvailable = text.includes("ã‚«ãƒ¼ãƒˆã«å…¥ã‚Œã‚‹");

        if (!isUnavailable || isAvailable) {
          if (lastStatus === "unavailable") {
            lastStatus = "available";
            logStatus("çŠ¶æ…‹å¤‰åŒ–ï¼šã‚«ãƒ¼ãƒˆã«å…¥ã‚Œã‚‹å¯èƒ½æ€§ã‚ã‚Š");
            if (Notification.permission === "granted") {
              const notification = new Notification("æ¥½å¤©ãƒ–ãƒƒã‚¯ã‚¹å•†å“çŠ¶æ…‹ãŒå¤‰åŒ–ï¼", {
                body: "ã‚«ãƒ¼ãƒˆã«å…¥ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚",
                icon: "https://books.rakuten.co.jp/favicon.ico",
                data: { url: url }
              });
              notification.onclick = e => {
                e.preventDefault();
                window.open(notification.data.url, "_blank");
              };
            }
            window.location.href = url;
          } else {
            logStatus("ãƒã‚§ãƒƒã‚¯å®Œäº†ï¼ˆçŠ¶æ…‹å¤‰åŒ–ãªã—ï¼‰");
          }
        } else {
          lastStatus = "unavailable";
          logStatus("ãƒã‚§ãƒƒã‚¯å®Œäº†ï¼ˆåœ¨åº«ãªã—ï¼‰");
        }
      } catch (err) {
        console.error("ãƒã‚§ãƒƒã‚¯å¤±æ•—:", err);
        logStatus("ãƒã‚§ãƒƒã‚¯å¤±æ•—");
      }
    }

    function scheduleNextCheck() {
      const now = new Date();
      const seconds = now.getSeconds();
      const delay = seconds < 30
        ? (30 - seconds) * 1000
        : (60 - seconds) * 1000;

      setTimeout(() => {
        checkStatus();
        scheduleNextCheck();
      }, delay);
    }

    scheduleNextCheck();
  </script>
</body>
</html>
