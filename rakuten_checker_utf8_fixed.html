<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æ¥½å¤©ãƒ–ãƒƒã‚¯ã‚¹é€šçŸ¥ãƒã‚§ãƒƒã‚«ãƒ¼</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    button { margin: 10px 0; padding: 10px 20px; font-size: 16px; }
  </style>
</head>
<body>
  <h1>æ¥½å¤©ãƒ–ãƒƒã‚¯ã‚¹é€šçŸ¥ãƒã‚§ãƒƒã‚«ãƒ¼</h1>
  <p>ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦é€šçŸ¥ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚</p>
  <button onclick="requestNotificationPermission()">ğŸ”” é€šçŸ¥ã‚’è¨±å¯ã™ã‚‹</button>
  <button onclick="sendTestNotification()">ğŸ§ª é€šçŸ¥ãƒ†ã‚¹ãƒˆ</button>
  <p>30ç§’ã”ã¨ã«å•†å“çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚</p>

  <script>
    const url = "https://books.rakuten.co.jp/rb/18210487/";
    let lastStatus = null;

    function requestNotificationPermission() {
      if (!("Notification" in window)) {
        alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
        return;
      }

      Notification.requestPermission().then(permission => {
        if (permission === "granted") {
          alert("é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸï¼");
        } else {
          alert("é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚");
        }
      });
    }

    function sendTestNotification() {
      if (Notification.permission === "granted") {
        const notification = new Notification("ãƒ†ã‚¹ãƒˆé€šçŸ¥", {
          body: "ã“ã‚Œã¯é€šçŸ¥æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆã§ã™ã€‚",
          icon: "https://books.rakuten.co.jp/favicon.ico",
          data: { url: url }
        });

        notification.onclick = function(event) {
          event.preventDefault();
          window.open(notification.data.url, "_blank");
        };
      } else {
        alert("é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å…ˆã«é€šçŸ¥ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚");
      }
    }

    async function checkStatus() {
      try {
        const response = await fetch(url);
        const text = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(text, "text/html");

        const statusElement = doc.querySelector(".availability, .salesStatus, .stockStatus");
        const statusText = statusElement ? statusElement.textContent.trim() : "çŠ¶æ…‹ä¸æ˜";

        console.log("ç¾åœ¨ã®çŠ¶æ…‹:", statusText);

        if (Notification.permission === "granted" && statusText !== lastStatus) {
          lastStatus = statusText;
          const notification = new Notification("æ¥½å¤©ãƒ–ãƒƒã‚¯ã‚¹å•†å“çŠ¶æ…‹ãŒå¤‰åŒ–ï¼", {
            body: statusText,
            icon: "https://books.rakuten.co.jp/favicon.ico",
            data: { url: url }
          });

          notification.onclick = function(event) {
            event.preventDefault();
            window.open(notification.data.url, "_blank");
          };
        }
      } catch (err) {
        console.error("ã‚¨ãƒ©ãƒ¼:", err);
      }
    }

    setInterval(checkStatus, 30000);
    checkStatus();
  </script>
</body>
</html>
